{% extends 'base.html' %}

{% block title %}Portfolio Details{% endblock %}

{% block navbar_subcontent %}
  <a href="{{ url_for('main.home') }}" class="btn btn-primary btn-sm">
    ‚Üê All Portfolios
  </a>
{% endblock %}

{% block content %}

<h1>{{ portfolio.portfolioname }}</h1>

<h3>Description: {{ portfolio.portfoliodescription or "No description" }}</h3>

<div class="d-flex justify-content-between align-items-center mb-3">
  <h2><strong>Total Value: {{ portfolio.currencycode }} {{ portfolio.total_value }}</strong></h2>
  
  <div>
    <a href="{{ url_for('main.securites_view', portfolio_id=portfolio['portfolioid']) }}" class="btn btn-primary me-1">
      View Securities
    </a>

    <button type="button" class="btn btn-success me-1" data-bs-toggle="modal" data-bs-target="#editPortfolioModal">
      Edit Details
    </button>

    <form method="POST" action="{{ url_for('main.delete_portfolio', portfolio_id=portfolio['portfolioid']) }}" style="display:inline;" 
          onsubmit="return confirm('Are you sure you want to delete this portfolio? This action cannot be undone.');">
      <button type="submit" class="btn btn-danger">
        Delete Portfolio
      </button>
    </form>
  </div>
</div>

<!-- Edit Portfolio Modal -->
<div class="modal fade" id="editPortfolioModal" tabindex="-1" aria-labelledby="editPortfolioModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">

      <!-- EDIT FORM -->
      <form method="POST" action="{{ url_for('main.update_portfolio_details', portfolio_id=portfolio['portfolioid']) }}">
        <div class="modal-header">
          <h5 class="modal-title" id="editPortfolioModalLabel">Edit Portfolio</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>

        <div class="modal-body">
          <!-- Name -->
          <div class="mb-3">
            <label for="portfolioName" class="form-label">Portfolio Name</label>
            <input type="text" class="form-control" id="portfolioName" name="portfolioname" value="{{ portfolio.portfolioname }}" maxlength="50">
          </div>

          <!-- Description -->
          <div class="mb-3">
            <label for="portfolioDescription" class="form-label">Description</label>
            <textarea class="form-control" id="portfolioDescription" name="portfoliodescription" rows="3" maxlength="255">{{ portfolio.portfoliodescription }}</textarea>
          </div>

          <!-- Currency -->
          <div class="mb-3">
            <label for="currencySymbol" class="form-label">Currency</label>
            <select class="form-select" id="currencySymbol" name="currency_symbol" required>
              {% for currency in currencies %}
                <option value="{{ currency.currencycode }}" {% if currency.currencycode == portfolio.currencycode %}selected{% endif %}>
                  {{ currency.currencycode }}
                </option>
              {% endfor %}
            </select>
          </div>
        </div>
        
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary">Save Changes</button>
        </div>
      </form>
    </div>
  </div>
</div>

<hr class="my-4">

<div class="row mx-0">
  <!-- Left Column: Pie Chart + Legend -->
  <div class="col-md-4 ps-0 d-flex flex-column align-items-center">
    <canvas id="assetBreakdownChart" class="breakdown-chart"></canvas>
    <div class="chart-legend" id="assetBreakdownLegend"></div>
  </div>

  <!-- Right Column: Table -->
  <div class="col-md-8 ps-0">
    <h1 class="mb-4">Asset Breakdown</h1>
    <table class="table table-bordered" id="assetBreakdownTable">
      <colgroup>
        <col style="width:40%">
        <col style="width:35%">
        <col style="width:25%">
      </colgroup>
      <thead>
        <tr>
          <th>Asset</th>
          <th>Value</th>
          <th>Percentage</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</div>

<hr class="my-4">

<div class="row mx-0">
  <!-- Left Column: Pie Chart + Legend -->
  <div class="col-md-4 ps-0 d-flex flex-column align-items-center">
    <canvas id="sectorBreakdownChart" class="breakdown-chart"></canvas>
    <div class="chart-legend" id="sectorBreakdownLegend"></div>
  </div>

  <!-- Right Column: Table -->
  <div class="col-md-8 ps-0">
    <h1 class="mb-4">Sector Breakdown</h1>
    <table class="table table-bordered" id="sectorBreakdownTable">
      <colgroup>
        <col style="width:40%">
        <col style="width:35%">
        <col style="width:25%">
      </colgroup>
      <thead>
        <tr>
          <th>Sector</th>
          <th>Value</th>
          <th>Percentage</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</div>

<hr class="my-4">

<div class="row mx-0">
  <!-- Left Column: Pie Chart + Legend -->
  <div class="col-md-4 ps-0 d-flex flex-column align-items-center">
    <canvas id="regionalBreakdownChart" class="breakdown-chart"></canvas>
    <div class="chart-legend" id="regionalBreakdownLegend"></div>
  </div>

  <!-- Right Column: Table -->
  <div class="col-md-8 ps-0">
    <h1 class="mb-4">Regional Breakdown</h1>
    <table class="table table-bordered" id="regionalBreakdownTable">
      <colgroup>
        <col style="width:40%">
        <col style="width:35%">
        <col style="width:25%">
      </colgroup>
      <thead>
        <tr>
          <th>Region</th>
          <th>Value</th>
          <th>Percentage</th>
        </tr>
      </thead>
      <tbody>
      </tbody>
    </table>
  </div>
</div>

{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
<script id="portfolio-data" type="application/json">
  {
    "categories": {{ categories | tojson }},
    "sectors": {{ sectors | tojson }},
    "regions": {{ regions | tojson }},
    "portfolio": {{ portfolio | tojson }}
  }
</script>
<script src="{{ url_for('static', filename='js/portfolioview.js') }}"></script>
{% endblock %}
