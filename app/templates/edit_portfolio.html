{% extends 'base.html' %}

{% block title %}Edit Portfolio Contents{% endblock %}

{% block breadcrumb_items %}
  <li class="breadcrumb-item">
    <a href="{{ url_for('main.portfolioview', portfolio_id=portfolio['portfolioid']) }}" class="text-decoration-none">
      <i class="fas fa-chart-pie me-1"></i>{{ portfolio.portfolioname }}
    </a>
  </li>
  <li class="breadcrumb-item">
    <a href="{{ url_for('main.securites_view', portfolio_id=portfolio['portfolioid']) }}" class="text-decoration-none">
      <i class="fas fa-coins me-1"></i>Securities
    </a>
  </li>
  <li class="breadcrumb-item active" aria-current="page">
    <i class="fas fa-edit me-1"></i>Edit Portfolio
  </li>
{% endblock %}

{% block navbar_subcontent %}
    <a href="{{ url_for('main.securites_view', portfolio_id=portfolio['portfolioid']) }}" class="btn btn-primary">
      ‚Üê Back to Securities
    </a>
{% endblock %}

{% block content %}

<!-- Professional Header -->
<div class="card border-0 shadow-sm mb-4">
  <div class="card-header bg-primary text-white">
    <div class="d-flex justify-content-between align-items-center">
      <div>
        <h4 class="mb-1">
          <i class="fas fa-edit me-2"></i>Edit Portfolio: {{ portfolio.portfolioname }}
        </h4>
        <p class="mb-0 opacity-75">Manage securities in your portfolio</p>
      </div>
    </div>
  </div>
</div>

<!-- Search and Filter Controls -->
<div class="card border-0 shadow-sm mb-4">
  <div class="card-body">
    <!-- First Row: Search, Ownership, Order -->
    <div class="row g-3 align-items-end mb-3">
      <!-- Search -->
      <div class="col-md-6">
        <label for="searchInput" class="form-label fw-semibold">
          <i class="fas fa-search me-2 text-muted"></i>Search
        </label>
        <div class="input-group">
          <span class="input-group-text">
            <i class="fas fa-search"></i>
          </span>
          <input id="searchInput" type="text" class="form-control" placeholder="Search by symbol or name...">
        </div>
      </div>
      
      <!-- Ownership Filter -->
      <div class="col-md-3">
        <label class="form-label fw-semibold">
          <i class="fas fa-filter me-2 text-muted"></i>Ownership
        </label>
        <div id="ownershipFilter" class="btn-group w-100" role="group" aria-label="Ownership filter">
          <input type="radio" class="btn-check" name="ownershipToggle" id="ownedToggle" value="Only Owned" autocomplete="off" checked>
          <label class="btn btn-outline-primary" for="ownedToggle">Owned</label>
          <input type="radio" class="btn-check" name="ownershipToggle" id="notOwnedToggle" value="Not Owned" autocomplete="off">
          <label class="btn btn-outline-primary" for="notOwnedToggle">Not Owned</label>
        </div>
      </div>
      
      <!-- Order Toggle -->
      <div class="col-md-3">
        <label for="sortOrderToggle" class="form-label fw-semibold">
          <i class="fas fa-sort-alpha-up me-2 text-muted"></i>Order
        </label>
        <div class="btn-group w-100" role="group">
          <input type="radio" class="btn-check" name="sortOrder" id="sortAsc" value="asc" checked>
          <label class="btn btn-outline-primary" for="sortAsc">
            <i class="fas fa-sort-alpha-up me-1"></i>A-Z
          </label>
          <input type="radio" class="btn-check" name="sortOrder" id="sortDesc" value="desc">
          <label class="btn btn-outline-primary" for="sortDesc">
            <i class="fas fa-sort-alpha-down me-1"></i>Z-A
          </label>
        </div>
      </div>
    </div>
    
    <!-- Second Row: Sort By and Filters -->
    <div class="row g-3 align-items-end">
      <!-- Sort By -->
      <div class="col-md-3">
        <label for="sortBySelect" class="form-label fw-semibold">
          <i class="fas fa-sort me-2 text-muted"></i>Sort By
        </label>
        <select id="sortBySelect" class="form-select">
          <option value="name" selected>Name</option>
          <option value="quantity">Quantity</option>
          <option value="price">Price</option>
        </select>
      </div>
      
      <!-- Category Filter -->
      <div class="col-md-3">
        <label for="categoryFilter" class="form-label fw-semibold">
          <i class="fas fa-filter me-2 text-muted"></i>Category
        </label>
        <select id="categoryFilter" class="form-select">
          <option value="All">All Categories</option>
          {% for category in categories %}
            <option value="{{ category.bondcategoryname }}">{{ category.bondcategoryname }}</option>
          {% endfor %}
        </select>
      </div>
      
      <!-- Region Filter -->
      <div class="col-md-3">
        <label for="regionFilter" class="form-label fw-semibold">
          <i class="fas fa-globe me-2 text-muted"></i>Region
        </label>
        <select id="regionFilter" class="form-select">
          <option value="All">All Regions</option>
          {% for region in regions %}
            <option value="{{ region.region }}">{{ region.region }}</option>
          {% endfor %}
        </select>
      </div>
      
      <!-- Sector Filter -->
      <div class="col-md-3">
        <label for="sectorFilter" class="form-label fw-semibold">
          <i class="fas fa-industry me-2 text-muted"></i>Sector
        </label>
        <select id="sectorFilter" class="form-select">
          <option value="All">All Sectors</option>
          {% for sector in sectors %}
            <option value="{{ sector.sectorname }}">{{ sector.sectordisplayname or sector.sectorname }}</option>
          {% endfor %}
        </select>
      </div>
    </div>
  </div>
</div>

<!-- Securities Table -->
<div class="card border-0 shadow-sm">
  <div class="card-body p-0">
    <div class="table-responsive" style="max-height: 500px; overflow-y: auto;">
      <table class="table table-hover mb-0" id="bondsTable1">
        <thead class="table-light sticky-top">
          <tr>
            <th class="border-0">
              <i class="fas fa-tag me-1 text-muted"></i>Symbol
            </th>
            <th class="border-0">
              <i class="fas fa-building me-1 text-muted"></i>Name
            </th>
            <th class="border-0">
              <i class="fas fa-layer-group me-1 text-muted"></i>Category
            </th>
            <th class="border-0 text-end" id="quantityPriceHeader">
              <i class="fas fa-hashtag me-1 text-muted"></i>Quantity
            </th>
            <th class="border-0 text-center">
              <i class="fas fa-cog me-1 text-muted"></i>Actions
            </th>
          </tr>
        </thead>
        <tbody>
          <!-- Hidden data for JavaScript -->
          <script>
            window.isAdmin = {{ is_admin|tojson }};
            window.securitiesOverviewUrl = "{{ url_for('admin.securityoverview') }}";
          </script>
          {% for bond in bonds %}
          <tr data-symbol="{{ bond.bondsymbol }}" 
              data-name="{{ bond.bondname }}" 
              data-category="{{ bond.bondcategoryname }}"
              data-region="{{ bond.region or '' }}"
              data-sector="{{ bond.sectorname or '' }}"
              data-owned="{{ 'yes' if bond.quantity > 0 else 'no' }}"
              class="align-middle">
            <td>
              <span class="fw-bold text-primary">{{ bond.bondsymbol }}</span>
            </td>
            <td>
              <div class="d-flex align-items-center">
                <div class="me-2">
                  <i class="fas fa-chart-line text-success"></i>
                </div>
                <div>
                  <div class="fw-medium">{{ bond.bondname }}</div>
                </div>
              </div>
            </td>
            <td>
              <span class="badge bg-secondary">{{ bond.bondcategoryname }}</span>
            </td>
            <td class="text-end" data-quantity="{{ bond.quantity }}" data-price="{{ "{:,.2f}".format(bond.bondrate|float) }} {{ bond.currencycode }}">
              <span class="fw-medium quantity-content">{{ "%.5f"|format(bond.quantity) }}</span>
              <span class="fw-medium price-content" style="display: none;">{{ "{:,.2f}".format(bond.bondrate|float) }} {{ bond.currencycode }}</span>
            </td>
            <td class="text-center">
              {% if bond.quantity > 0 %}
                <div class="d-flex gap-2 justify-content-center">
                  <button type="button" class="btn btn-outline-primary btn-sm" data-bs-toggle="modal" data-bs-target="#changeQuantityModal{{ bond.bondid }}">
                    <i class="fas fa-edit me-1"></i>Edit
                  </button>
                  <form method="POST" action="{{ url_for('main.update_securities', portfolio_id=portfolio.portfolioid) }}" style="display: inline;" onsubmit="return confirm('Are you sure you want to remove this security from the portfolio?');">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                    <button type="submit" name="delete_bond" value="{{ bond.bondid }}" class="btn btn-outline-danger btn-sm">
                      <i class="fas fa-trash me-1"></i>Remove
                    </button>
                  </form>
                </div>
              {% else %}
                <button type="button" class="btn btn-outline-success btn-sm add-to-portfolio-btn" data-bondid="{{ bond.bondid }}" data-bondsymbol="{{ bond.bondsymbol }}">
                  <i class="fas fa-plus me-1"></i>Add
                </button>
              {% endif %}
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>

<!-- Quantity Change Modals -->
{% for bond in bonds %}
  {% if bond.quantity > 0 %}
    <div class="modal fade" id="changeQuantityModal{{ bond.bondid }}" tabindex="-1" aria-labelledby="changeQuantityLabel{{ bond.bondid }}" aria-hidden="true">
      <div class="modal-dialog modal-lg">
        <form method="POST" action="{{ url_for('main.update_securities', portfolio_id=portfolio.portfolioid) }}">
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
          <div class="modal-content border-0 shadow-lg">
            <div class="modal-header bg-primary text-white">
              <h5 class="modal-title" id="changeQuantityLabel{{ bond.bondid }}">
                <i class="fas fa-edit me-2"></i>Edit Quantity
              </h5>
              <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <div class="row g-3">
                <div class="col-md-6">
                  <label class="form-label fw-semibold">
                    <i class="fas fa-tag me-2 text-muted"></i>Security
                  </label>
                  <div class="form-control-plaintext fw-bold text-primary">{{ bond.bondsymbol }}</div>
                </div>
                <div class="col-md-6">
                  <label class="form-label fw-semibold">
                    <i class="fas fa-building me-2 text-muted"></i>Company
                  </label>
                  <div class="form-control-plaintext">{{ bond.bondname }}</div>
                </div>
                <div class="col-md-6">
                  <label class="form-label fw-semibold">
                    <i class="fas fa-hashtag me-2 text-muted"></i>Current Quantity
                  </label>
                  <div class="form-control-plaintext fw-bold text-success">{{ "%.5f"|format(bond.quantity) }}</div>
                </div>
                <div class="col-md-6">
                  <label for="new_quantity{{ bond.bondid }}" class="form-label fw-semibold">
                    <i class="fas fa-edit me-2 text-muted"></i>New Quantity
                  </label>
                  <input type="number" name="new_quantity" id="new_quantity{{ bond.bondid }}" min="0.00001" step="0.00001" value="{{ bond.quantity }}" class="form-control form-control-lg" required>
                  <div class="form-text">Enter the new quantity for this security (supports fractional shares)</div>
                </div>
              </div>
              <input type="hidden" name="change_bond_id" value="{{ bond.bondid }}">
            </div>
            <div class="modal-footer bg-light">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                <i class="fas fa-times me-1"></i>Cancel
              </button>
              <button type="submit" class="btn btn-primary flex-fill">
                <i class="fas fa-save me-1"></i>Update Quantity
              </button>
            </div>
          </div>
        </form>
      </div>
    </div>
  {% endif %}
{% endfor %}

<!-- Add Modal -->
<div class="modal fade" id="addBondModal" tabindex="-1" aria-labelledby="addBondModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <form method="POST" action="{{ url_for('main.update_securities', portfolio_id=portfolio.portfolioid) }}" id="addBondForm">
      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
      <div class="modal-content border-0 shadow-lg">
        <div class="modal-header bg-success text-white">
          <h5 class="modal-title" id="addBondModalLabel">
            <i class="fas fa-plus me-2"></i>Add Security to Portfolio
          </h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="row g-3">
            <div class="col-md-6">
              <label class="form-label fw-semibold">
                <i class="fas fa-tag me-2 text-muted"></i>Security Symbol
              </label>
              <div class="form-control-plaintext fw-bold text-primary" id="modalBondSymbol"></div>
            </div>
            <div class="col-md-6">
              <label class="form-label fw-semibold">
                <i class="fas fa-building me-2 text-muted"></i>Company Name
              </label>
              <div class="form-control-plaintext" id="modalBondName"></div>
            </div>
            <div class="col-md-12">
              <label for="quantity" class="form-label fw-semibold">
                <i class="fas fa-hashtag me-2 text-muted"></i>Quantity to Add
              </label>
              <input type="number" name="quantity" id="quantity" min="0.00001" step="0.00001" value="1" class="form-control form-control-lg" required>
              <div class="form-text">Enter the number of units you want to add to your portfolio (supports fractional shares)</div>
            </div>
          </div>
          <input type="hidden" name="add_bond" id="modalBondId" value="">
        </div>
        <div class="modal-footer bg-light">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
            <i class="fas fa-times me-1"></i>Cancel
          </button>
          <button type="submit" class="btn btn-success flex-fill">
            <i class="fas fa-plus me-1"></i>Add to Portfolio
          </button>
        </div>
      </div>
    </form>
  </div>
</div>

{% endblock %}

{% block extra_js %}
<script src="{{ url_for('static', filename='js/edit_portfolio.js') }}"></script>
{% endblock %}