{% extends 'base.html' %}

{% block title %}Settings{% endblock %}

{% block breadcrumb_items %}
  <li class="breadcrumb-item active" aria-current="page">
    <i class="fas fa-cog me-1"></i>Settings
  </li>
{% endblock %}

{% block navbar_subcontent %}
  <a href="{{ url_for('main.home') }}" class="btn btn-primary">
    ← Back to Dashboard
  </a>
{% endblock %}

{% block content %}
<div class="container-fluid">
  <div class="row">
    <div class="col-12">
      <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
          <h1 class="mb-0">User Settings</h1>
          <p class="text-muted mb-0">Manage your account preferences and application settings</p>
        </div>
        <div class="text-muted">
          <i class="fas fa-cog me-2"></i>Settings
        </div>
      </div>
    </div>
  </div>

  <!-- Settings List -->
  <div class="row">
    <div class="col-12">
      <div class="card shadow-sm border-0 mb-4">
        <div class="card-header bg-white border-0 py-3">
          <h5 class="mb-0">
            <i class="fas fa-cog me-2 text-primary"></i>Account Settings
          </h5>
        </div>
        <div class="card-body p-0">
          <!-- Username Setting -->
          <div class="list-group-item border-0 py-3 px-4">
            <div class="d-flex align-items-center justify-content-between">
              <div class="d-flex align-items-center">
                <div class="bg-primary bg-opacity-10 rounded-circle p-2 me-3">
                  <i class="fas fa-user text-primary"></i>
                </div>
                <div>
                  <h6 class="mb-1 fw-semibold">Username</h6>
                  <p class="text-muted mb-0">{{ user.username }}</p>
                </div>
              </div>
              <button type="button" class="btn btn-outline-primary btn-sm" data-bs-toggle="modal" data-bs-target="#editUsernameModal">
                <i class="fas fa-edit me-1"></i>Edit
              </button>
            </div>
          </div>

          <!-- Email Setting -->
          <div class="list-group-item border-0 py-3 px-4 border-top">
            <div class="d-flex align-items-center justify-content-between">
              <div class="d-flex align-items-center">
                <div class="bg-info bg-opacity-10 rounded-circle p-2 me-3">
                  <i class="fas fa-envelope text-info"></i>
                </div>
                <div>
                  <h6 class="mb-1 fw-semibold">Email Address</h6>
                  <p class="text-muted mb-0">{{ user.email or 'N/A' }}</p>
                </div>
              </div>
              <button type="button" class="btn btn-outline-info btn-sm position-relative" data-bs-toggle="modal" data-bs-target="#editEmailModal">
                <i class="fas fa-edit me-1"></i>Edit
                {% if user.email == 'N/A' %}
                <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger" style="font-size: 0.5rem;">
                  !
                </span>
                {% endif %}
              </button>
            </div>
          </div>

          <!-- Password Setting -->
          <div class="list-group-item border-0 py-3 px-4 border-top">
            <div class="d-flex align-items-center justify-content-between">
              <div class="d-flex align-items-center">
                <div class="bg-warning bg-opacity-10 rounded-circle p-2 me-3">
                  <i class="fas fa-key text-warning"></i>
                </div>
                <div>
                  <h6 class="mb-1 fw-semibold">Password</h6>
                  <p class="text-muted mb-0">••••••••</p>
                </div>
              </div>
              <button type="button" class="btn btn-outline-warning btn-sm" data-bs-toggle="modal" data-bs-target="#editPasswordModal">
                <i class="fas fa-edit me-1"></i>Edit
              </button>
            </div>
          </div>

          <!-- Currency Setting -->
          <div class="list-group-item border-0 py-3 px-4 border-top">
            <div class="d-flex align-items-center justify-content-between">
              <div class="d-flex align-items-center">
                <div class="bg-success bg-opacity-10 rounded-circle p-2 me-3">
                  <i class="fas fa-coins text-success"></i>
                </div>
                <div>
                  <h6 class="mb-1 fw-semibold">Default Base Currency</h6>
                  <p class="text-muted mb-0">{{ current_currency_code or 'USD' }}</p>
                </div>
              </div>
              <button type="button" class="btn btn-outline-success btn-sm position-relative" data-bs-toggle="modal" data-bs-target="#editCurrencyModal">
                <i class="fas fa-edit me-1"></i>Edit
                {% if user.default_base_currency == 1 %}
                <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger" style="font-size: 0.5rem;">
                  !
                </span>
                {% endif %}
              </button>
            </div>
          </div>

          <!-- Account Info -->
          <div class="list-group-item border-0 py-3 px-4 border-top bg-light">
            <div class="d-flex align-items-center">
              <div class="bg-secondary bg-opacity-10 rounded-circle p-2 me-3">
                <i class="fas fa-calendar text-secondary"></i>
              </div>
              <div>
                <h6 class="mb-1 fw-semibold">Account Created</h6>
                <p class="text-muted mb-0">{{ user.created_at.strftime('%B %d, %Y') if user.created_at else 'N/A' }}</p>
              </div>
            </div>
          </div>

          {% if user.is_admin %}
          <!-- Admin Badge -->
          <div class="list-group-item border-0 py-3 px-4 border-top bg-light">
            <div class="d-flex align-items-center">
              <div class="bg-warning bg-opacity-10 rounded-circle p-2 me-3">
                <i class="fas fa-crown text-warning"></i>
              </div>
              <div>
                <h6 class="mb-1 fw-semibold">Account Type</h6>
                <p class="text-muted mb-0">Administrator Account</p>
              </div>
            </div>
          </div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>

  <!-- Danger Zone -->
  <div class="row">
    <div class="col-12">
      <div class="card shadow-sm border-0 border-danger">
        <div class="card-header bg-danger text-white border-0 py-3">
          <h5 class="mb-0">
            <i class="fas fa-exclamation-triangle me-2"></i>Danger Zone
          </h5>
        </div>
        <div class="card-body">
          <div class="d-flex align-items-center">
            <div class="flex-grow-1">
              <h6 class="mb-1">Delete Account</h6>
              {% if user.id == 1 %}
                <p class="text-muted mb-0">The original admin account cannot be deleted for system security.</p>
              {% else %}
                <p class="text-muted mb-0">Permanently delete your account and all associated data. This action cannot be undone.</p>
              {% endif %}
            </div>
            {% if user.id != 1 %}
              <button type="button" class="btn btn-danger" data-bs-toggle="modal" data-bs-target="#deleteAccountModal">
                <i class="fas fa-trash me-2"></i>Delete Account
              </button>
            {% else %}
              <button type="button" class="btn btn-danger" disabled>
                <i class="fas fa-shield-alt me-2"></i>Protected Account
              </button>
            {% endif %}
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Edit Username Modal -->
<div class="modal fade" id="editUsernameModal" tabindex="-1" aria-labelledby="editUsernameModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content border-0 shadow-lg">
      <div class="modal-header bg-primary text-white border-0">
        <h5 class="modal-title" id="editUsernameModalLabel">
          <i class="fas fa-user me-2"></i>Edit Username
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form method="POST" action="{{ url_for('main.update_username') }}">
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
          <div class="mb-3">
            <label for="newUsername" class="form-label fw-semibold">
              <i class="fas fa-user me-2 text-muted"></i>New Username
            </label>
            <input type="text" class="form-control" id="newUsername" name="new_username" value="{{ user.username }}" required>
            <div class="form-text">Username must be 3-50 characters long and unique.</div>
          </div>
          <div class="modal-footer bg-light border-0">
            <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
              <i class="fas fa-times me-2"></i>Cancel
            </button>
            <button type="submit" class="btn btn-primary">
              <i class="fas fa-save me-2"></i>Update Username
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- Edit Email Modal -->
<div class="modal fade" id="editEmailModal" tabindex="-1" aria-labelledby="editEmailModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content border-0 shadow-lg">
      <div class="modal-header bg-info text-white border-0">
        <h5 class="modal-title" id="editEmailModalLabel">
          <i class="fas fa-envelope me-2"></i>Edit Email Address
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form method="POST" action="{{ url_for('main.update_email') }}">
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
          <div class="mb-3">
            <label for="newEmail" class="form-label fw-semibold">
              <i class="fas fa-envelope me-2 text-muted"></i>New Email Address
            </label>
            <input type="email" class="form-control" id="newEmail" name="new_email" value="{{ user.email if user.email != 'N/A' else '' }}" placeholder="{{ user.email if user.email == 'N/A' else 'Enter new email address' }}" required>
            <div class="form-text">Enter a valid email address.</div>
          </div>
          <div class="modal-footer bg-light border-0">
            <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
              <i class="fas fa-times me-2"></i>Cancel
            </button>
            <button type="submit" class="btn btn-info">
              <i class="fas fa-save me-2"></i>Update Email
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- Edit Password Modal -->
<div class="modal fade" id="editPasswordModal" tabindex="-1" aria-labelledby="editPasswordModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content border-0 shadow-lg">
      <div class="modal-header bg-warning text-white border-0">
        <h5 class="modal-title" id="editPasswordModalLabel">
          <i class="fas fa-key me-2"></i>Change Password
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form method="POST" action="{{ url_for('main.update_password') }}">
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
          <div class="mb-3">
            <label for="currentPassword" class="form-label fw-semibold">
              <i class="fas fa-lock me-2 text-muted"></i>Current Password
            </label>
            <input type="password" class="form-control" id="currentPassword" name="current_password" required>
            <div class="form-text">Enter your current password to verify your identity.</div>
          </div>
          <div class="mb-3">
            <label for="newPassword" class="form-label fw-semibold">
              <i class="fas fa-key me-2 text-muted"></i>New Password
            </label>
            <input type="password" class="form-control" id="newPassword" name="new_password" required>
            <div class="form-text">Enter your new password.</div>
          </div>
          <div class="mb-3">
            <label for="confirmPassword" class="form-label fw-semibold">
              <i class="fas fa-check me-2 text-muted"></i>Confirm New Password
            </label>
            <input type="password" class="form-control" id="confirmPassword" name="confirm_password" required>
            <div class="form-text">Re-enter your new password to confirm.</div>
          </div>
          <div class="modal-footer bg-light border-0">
            <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
              <i class="fas fa-times me-2"></i>Cancel
            </button>
            <button type="submit" class="btn btn-warning">
              <i class="fas fa-save me-2"></i>Update Password
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- Edit Currency Modal -->
<div class="modal fade" id="editCurrencyModal" tabindex="-1" aria-labelledby="editCurrencyModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content border-0 shadow-lg">
      <div class="modal-header bg-success text-white border-0">
        <h5 class="modal-title" id="editCurrencyModalLabel">
          <i class="fas fa-coins me-2"></i>Edit Default Currency
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form method="POST" action="{{ url_for('main.update_currency') }}">
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
          <div class="mb-3">
            <label for="newCurrency" class="form-label fw-semibold">
              <i class="fas fa-coins me-2 text-muted"></i>Default Base Currency
            </label>
            <select class="form-select" id="newCurrency" name="default_currency" required>
              {% for currency in currencies %}
                <option value="{{ currency.currencycode }}" {% if currency.currencycode == current_currency_code %}selected{% endif %}>
                  {{ currency.currencycode }}
                </option>
              {% endfor %}
            </select>
            <div class="form-text">This will be used as the default currency for portfolio calculations and displays.</div>
          </div>
          <div class="modal-footer bg-light border-0">
            <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
              <i class="fas fa-times me-2"></i>Cancel
            </button>
            <button type="submit" class="btn btn-success">
              <i class="fas fa-save me-2"></i>Update Currency
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>


<div class="modal fade" id="deleteAccountModal" tabindex="-1" aria-labelledby="deleteAccountModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content border-0 shadow-lg">
      <div class="modal-header bg-danger text-white border-0">
        <h5 class="modal-title" id="deleteAccountModalLabel">
          <i class="fas fa-trash me-2"></i>Delete Account
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="text-center mb-4">
          <i class="fas fa-exclamation-triangle text-danger" style="font-size: 3rem;"></i>
          <h5 class="mt-3 text-danger">Are you absolutely sure?</h5>
          <p class="text-muted">This action cannot be undone. This will permanently delete your account and remove all data from our servers.</p>
        </div>
        <form method="POST" action="{{ url_for('main.delete_account') }}">
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
          <div class="mb-3">
            <label for="confirmDelete" class="form-label fw-semibold">
              <i class="fas fa-key me-2 text-muted"></i>Enter your password to confirm
            </label>
            <input type="password" class="form-control" id="confirmDelete" name="confirm_password" required placeholder="Enter your current password">
          </div>
          <div class="mb-3">
            <div class="form-check">
              <input class="form-check-input" type="checkbox" id="confirmCheckbox" required>
              <label class="form-check-label" for="confirmCheckbox">
                I understand that this action is permanent and cannot be undone
              </label>
            </div>
          </div>
          <div class="modal-footer bg-light border-0">
            <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
              <i class="fas fa-times me-2"></i>Cancel
            </button>
            <button type="submit" class="btn btn-danger">
              <i class="fas fa-trash me-2"></i>Delete Account
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
function resetForm() {
  document.getElementById('defaultCurrency').value = 'USD';
  document.getElementById('dateFormat').value = 'MM/DD/YYYY';
  document.getElementById('numberFormat').value = 'US';
  document.getElementById('emailNotifications').checked = true;
  document.getElementById('darkMode').checked = false;
}

// Track currency edit button clicks
document.addEventListener('DOMContentLoaded', function() {
  const userId = {{ user.id }};
  const emailEditKey = `emailEditClicked_${userId}`;
  const currencyEditKey = `currencyEditClicked_${userId}`;
  
  const currencyEditBtn = document.querySelector('[data-bs-target="#editCurrencyModal"]');
  if (currencyEditBtn) {
    currencyEditBtn.addEventListener('click', function() {
      // Mark that user has clicked on currency edit button
      localStorage.setItem(currencyEditKey, 'true');
      
      // Hide the red dot on the currency edit button
      const currencyDot = currencyEditBtn.querySelector('.badge');
      if (currencyDot) {
        currencyDot.style.display = 'none';
      }
      
      // Update the home page notification if it exists
      updateHomeNotification();
    });
  }
  
  // Track email edit button clicks
  const emailEditBtn = document.querySelector('[data-bs-target="#editEmailModal"]');
  if (emailEditBtn) {
    emailEditBtn.addEventListener('click', function() {
      // Mark that user has clicked on email edit button
      localStorage.setItem(emailEditKey, 'true');
      
      // Hide the red dot on the email edit button
      const emailDot = emailEditBtn.querySelector('.badge');
      if (emailDot) {
        emailDot.style.display = 'none';
      }
      
      // Update the home page notification
      updateHomeNotification();
    });
  }
  
  // Check localStorage and hide dots if buttons were already clicked
  const emailEditClicked = localStorage.getItem(emailEditKey) === 'true';
  const currencyEditClicked = localStorage.getItem(currencyEditKey) === 'true';
  
  if (emailEditClicked && emailEditBtn) {
    const emailDot = emailEditBtn.querySelector('.badge');
    if (emailDot) {
      emailDot.style.display = 'none';
    }
  }
  
  if (currencyEditClicked && currencyEditBtn) {
    const currencyDot = currencyEditBtn.querySelector('.badge');
    if (currencyDot) {
      currencyDot.style.display = 'none';
    }
  }
  
  // Check if email has been updated (not N/A)
  const emailValue = '{{ user.email }}';
  if (emailValue !== 'N/A') {
    localStorage.setItem('emailSet', 'true');
    updateHomeNotification();
  }
  
  // Check if currency has been customized (not default USD)
  const currencyValue = {{ user.default_base_currency }};
  if (currencyValue !== 1) {
    localStorage.setItem('currencyCustomized', 'true');
    updateHomeNotification();
  }
});

function updateHomeNotification() {
  // This function will be called to update the home page notification
  // The actual update will happen on the next page load
  console.log('Notification status updated');
}
</script>
{% endblock %}
